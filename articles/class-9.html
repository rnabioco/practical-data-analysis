<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="pbda">
<title>Class 9: Exploring data with PCA • pbda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><link href="../deps/_Source%20Sans%20Pro-0.4.1/font.css" rel="stylesheet">
<link href="../deps/_Source%20Code%20Pro-0.4.1/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Class 9: Exploring data with PCA">
<meta property="og:description" content="pbda">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="rnabioco.github.io" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">pbda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">Home</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-class-material">Class Material</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-class-material">
    <a class="dropdown-item" href="../articles/class-1.html">Class 1: Overview, Data Import and Tidying</a>
    <a class="dropdown-item" href="../articles/class-2.html">Class 2: Analyzing qPCR data</a>
    <a class="dropdown-item" href="../articles/class-5.html">Class 5: Basic Data Types and Structures</a>
    <a class="dropdown-item" href="../articles/class-6.html">Class 6: Writing Functions</a>
    <a class="dropdown-item" href="../articles/class-7.html">Class 7: Iteration</a>
    <a class="dropdown-item" href="../articles/class-8.html">Class 8: Heatmaps and Clustering</a>
    <a class="dropdown-item" href="../articles/class-9.html">Class 9: Exploring data with PCA</a>
    <a class="dropdown-item" href="../articles/class-10.html">Class 10: Jumping into more complex R, tips, resources</a>
    <a class="dropdown-item" href="../articles/class-11.html">Class 11: RNA-seq Analysis</a>
    <a class="dropdown-item" href="../articles/class-12.html">Class 12: Working with gene lists</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/assignments.html">Assignment Submission and Grading Rubric</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rnabioco/practical-data-analysis/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Class 9: Exploring data with PCA</h1>
                        <h4 data-toc-skip class="author">Kent Riemondy</h4>
            
            <h4 data-toc-skip class="date">2022-07-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rnabioco/practical-data-analysis/blob/HEAD/vignettes/class-9.Rmd" class="external-link"><code>vignettes/class-9.Rmd</code></a></small>
      <div class="d-none name"><code>class-9.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap" class="external-link">ComplexHeatmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/slowkow/ggrepel" class="external-link">ggrepel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rnabioco/practical-data-analysis" class="external-link">pbda</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Goals: Use PCA to identify sources of variation and summarize relationship between variables/samples in a large dataset.</p>
<div class="section level2">
<h2 id="pca">PCA<a class="anchor" aria-label="anchor" href="#pca"></a>
</h2>
<p>As we’ve learned throughout the class, you need to visualize your data to identify key patterns. However, high dimensional datasets are difficult to visualize in a meaningful way. For example how do you find a pattern in a large sequencing dataset with 100 samples, and 20,000 genes?</p>
<p>Heatmaps provide one way to visualize selectively gene sets for a relatively small number of samples, but discerning overall patterns between samples can still be difficult, even with clustering.</p>
<p>Principle Component Analysis is a commonly used technique to examine the structure of large datasets.</p>
<p>Resources:</p>
<ul>
<li><a href="http://setosa.io/ev/principal-component-analysis/" class="external-link">PCA Explained Visually</a></li>
<li><a href="https://en.wikipedia.org/wiki/Principal_component_analysis" class="external-link">PCA formal explanation</a></li>
<li><a href="https://stats.stackexchange.com/questions/2691/making-sense-of-principal-component-analysis-eigenvectors-eigenvalues" class="external-link">PCA informal explanation</a></li>
</ul>
<div class="section level3">
<h3 id="background-on-pca">Background on PCA<a class="anchor" aria-label="anchor" href="#background-on-pca"></a>
</h3>
<p>PCA takes a set of variables and generates a new set of variables. The new variables are selected to capture the maximal variance in the data.</p>
<p>Each new variable is known as a principal component. The first principal component represents a linear combination of the original variables that captures the maximum variance in the dataset. Basically find a vector through the dataset that captures the maximum variance.</p>
<p>The second component is also a linear combination of the original variables but is uncorrelated to the first component.</p>
<p>In this manner PCA generates a new set of variables that are ordered based on the variance captured in the data. It’s for this reason that is so useful for exploratory analysis and dimensionality reduction.</p>
<p>Consider the following experiment where we measure gene expression for 2 genes in 100 samples. Because there are only 2 genes, we can visualize all of the data in a 2D scatterplot.</p>
<p>First, let’s generate some example data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate some correlated variables, scale, and make tidy </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span><span class="fl">100</span>,</span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.95</span>, <span class="fl">0.95</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                     <span class="fl">2</span>,</span>
<span>                     <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames_to_column</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">V1</span>, <span class="va">V2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>gene_1 <span class="op">=</span> <span class="va">V1</span>, gene_2 <span class="op">=</span> <span class="va">V2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 100 × 3</span></span></span>
<span><span class="co">#&gt;       id gene_1 gene_2</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1  -<span style="color: #BB0000;">3.00</span>  -<span style="color: #BB0000;">2.12</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2  -<span style="color: #BB0000;">2.82</span>  -<span style="color: #BB0000;">2.93</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3  -<span style="color: #BB0000;">2.28</span>  -<span style="color: #BB0000;">2.38</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4  -<span style="color: #BB0000;">2.17</span>  -<span style="color: #BB0000;">2.54</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5  -<span style="color: #BB0000;">1.53</span>  -<span style="color: #BB0000;">1.31</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6  -<span style="color: #BB0000;">1.52</span>  -<span style="color: #BB0000;">1.93</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7  -<span style="color: #BB0000;">1.52</span>  -<span style="color: #BB0000;">1.81</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8  -<span style="color: #BB0000;">1.42</span>  -<span style="color: #BB0000;">1.99</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9  -<span style="color: #BB0000;">1.30</span>  -<span style="color: #BB0000;">1.41</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10  -<span style="color: #BB0000;">1.29</span>  -<span style="color: #BB0000;">1.38</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 90 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># select points to label for visualization</span></span>
<span><span class="va">max_min_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">95</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make a plot</span></span>
<span><span class="va">og_plt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">gene_1</span>, <span class="va">gene_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">max_min_points</span>, </span>
<span>                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># scale y axis to same as x</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">gene_1</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">gene_2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">og_plt</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-1-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Next we’ll run PCA on this simulated data using the <code>prcomp</code> function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run pca</span></span>
<span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">sim</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span>, </span>
<span>             center <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>             scale. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><code>prcomp</code> returns an object of class <code>prcomp</code> with a few slots. The <code>x</code> slot contains the principal components in a matrix.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pc</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "sdev"     "rotation" "center"   "scale"    "x"</span></span></code></pre></div>
<p>For ease of plotting I will define a function to make a plot.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to make a pretty labeled plot</span></span>
<span></span>
<span><span class="va">plot_labeled_pca</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_data</span>, </span>
<span>                             <span class="va">pca_obj</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">#tidy the pc matrix</span></span>
<span>  <span class="va">pc_x</span> <span class="op">&lt;-</span> <span class="va">pca_obj</span><span class="op">$</span><span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">input_data</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> </span>
<span> </span>
<span>  <span class="co"># select points to label</span></span>
<span>  <span class="va">max_min_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="va">pc_x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">95</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># compute variance explained</span></span>
<span>  <span class="va">percent_var</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">pca_obj</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pca_obj</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#plot the data</span></span>
<span>  <span class="va">pca_plt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pc_x</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">PC1</span>, <span class="va">PC2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">max_min_points</span>, </span>
<span>                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="st">"PC1 "</span>, <span class="va">percent_var</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"%"</span><span class="op">)</span>,</span>
<span>         y <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="st">"PC2 "</span>, <span class="va">percent_var</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"%"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># make axes symmetric</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">pc_x</span><span class="op">$</span><span class="va">PC1</span><span class="op">)</span>, </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pc_x</span><span class="op">$</span><span class="va">PC1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">pca_plt</span> </span>
<span><span class="op">}</span></span></code></pre></div>
<p>If we plot out the new variables PC1 and PC2 you can see that now the data has been flattened and spread out along the PC1 axis.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pca_plt</span> <span class="op">&lt;-</span> <span class="fu">plot_labeled_pca</span><span class="op">(</span><span class="va">sim</span>, <span class="va">pc</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pca_plt</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-5-1.png" width="480" style="display: block; margin: auto;"></p>
<p>As we can see, PCA has refactored the data such that PC1 now represents a vector through the data that captures the most variance. The second PC, now represents a distinct type of variance represented as variance perpendicular to the y = x line.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">og_plt</span>, <span class="va">pca_plt</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Another way to demonstrate what PCA is doing is to show the information captured by each PC. (see post <a href="https://stats.stackexchange.com/questions/229092/how-to-reverse-pca-and-reconstruct-original-variables-from-several-principal-com?noredirect=1&amp;lq=1" class="external-link">here</a>)</p>
<p><img src="img/pca.png" width="700px" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="example-with-more-dimensions">Example with more dimensions<a class="anchor" aria-label="anchor" href="#example-with-more-dimensions"></a>
</h3>
<p>What if we had more dimensions that are just noise? How does this impact PCA?</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate a matrix of random numbers </span></span>
<span><span class="co"># drawn from a normal dist. to simulate noise</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20181214</span><span class="op">)</span></span>
<span><span class="va">more_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span>, </span>
<span>                           mean <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                           sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>, </span>
<span>                     nrow <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                     ncol <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add column names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">more_genes</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="st">"gene_noise_"</span>,</span>
<span>                              <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">more_genes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add the matrix to the simulation data_frame by column</span></span>
<span><span class="va">sim_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">sim</span>, <span class="va">more_genes</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">sim_2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="co">#&gt;   id    gene_1    gene_2 gene_noise_1 gene_noise_2 gene_noise_3</span></span>
<span><span class="co">#&gt; 1  1 -2.995217 -2.123704  0.089215287  -0.40819808  -0.48037882</span></span>
<span><span class="co">#&gt; 2  2 -2.821900 -2.933205 -0.339377410  -0.03582506   0.41886793</span></span>
<span><span class="co">#&gt; 3  3 -2.278693 -2.375272  0.131539067  -0.42624492   0.28643147</span></span>
<span><span class="co">#&gt; 4  4 -2.167279 -2.535480  0.098178061  -0.20509451  -0.06692551</span></span>
<span><span class="co">#&gt; 5  5 -1.528019 -1.310610  0.007170167   0.04159706   0.03533156</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> function can be used to quickly generate many exploratory plots. If you pass two vectors of the same length, you will get a scatterplot.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim_2</span><span class="op">$</span><span class="va">gene_1</span>, <span class="va">sim_2</span><span class="op">$</span><span class="va">gene_2</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-9-1.png" width="480" style="display: block; margin: auto;"></p>
<p>However, if you supply <code>plot</code> with a data.frame with only numeric values, it will plot all of the cross comparisons of the columns, which is useful in this example to quickly highlight that <code>gene_1</code> and <code>gene_2</code> are the only correlated or interesting variables.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim_2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Now if we had 2000 dimensions (i.e. genes) we couldn’t resonably investigate all of the scatterplots for each gene compared to each other gene. Even with a small real dataset with 10 genes, it’s hard to identify important relationships.</p>
<p>Next we’ll run PCA on this new data</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">sim_2</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">sim_2</span><span class="op">)</span><span class="op">]</span>, </span>
<span>              center <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>              scale. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pc2_plt</span> <span class="op">&lt;-</span> <span class="fu">plot_labeled_pca</span><span class="op">(</span><span class="va">sim_2</span>, <span class="va">pc2</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">og_plt</span>, <span class="va">pc2_plt</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="how-much-variation-is-captured-by-each-pc">How much variation is captured by each PC?<a class="anchor" aria-label="anchor" href="#how-much-variation-is-captured-by-each-pc"></a>
</h3>
<p>The <code>sdev</code> slot contains the standard deviation of the principal components. The square of this value is the variance explained by the PC.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sds</span> <span class="op">&lt;-</span> <span class="va">pc2</span><span class="op">$</span><span class="va">sdev</span></span>
<span></span>
<span><span class="co"># get variance per pc</span></span>
<span><span class="va">var_per_pc</span> <span class="op">&lt;-</span> <span class="va">sds</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span><span class="co">#calculate percent variance per pc</span></span>
<span><span class="va">percent_var_per_pc</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">var_per_pc</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">var_per_pc</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#plot a vector</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">percent_var_per_pc</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-13-1.png" width="480" style="display: block; margin: auto;"></p>
<p>As we can see most of the variation in the data is captured in the first PC. This means that if we dropped the remaining PCs from the data we would lose very little information. It is for this reason that PCA is so useful for dimensionality reduction for big datasets like single cell RNA-seq.</p>
</div>
<div class="section level3">
<h3 id="how-to-find-features-genes-associated-with-each-pc">How to find features (genes) associated with each PC<a class="anchor" aria-label="anchor" href="#how-to-find-features-genes-associated-with-each-pc"></a>
</h3>
<p>As we have learned each PC is linear combination of the features (i.e genes) in the data. How do we determine which features are most important for each PC?</p>
<p>The <code>rotation</code> slot of the <code>prcomp</code> object contains the rotations (also known as loadings) for each PC. These loadings can be interpreted as the amount each feature contributes to a principle component. Strongly positive loadings mean that the feature is strongly positivlye correlated with the PC. Strongly negative loadings indicate that it is strongly negatively correlated. Loadings at zero indicate no contribution.</p>
<p>By ranking the loadings we can identify which genes impact each PC.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pc2</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;                         PC1         PC2         PC3</span></span>
<span><span class="co">#&gt; gene_1         0.7053063021 -0.04871949  0.01920815</span></span>
<span><span class="co">#&gt; gene_2         0.7053462316  0.03364238 -0.02973091</span></span>
<span><span class="co">#&gt; gene_noise_1   0.0230621826  0.02051417 -0.08251792</span></span>
<span><span class="co">#&gt; gene_noise_2   0.0319279005  0.21472325  0.07504765</span></span>
<span><span class="co">#&gt; gene_noise_3  -0.0143038106 -0.11483800 -0.03152142</span></span>
<span><span class="co">#&gt; gene_noise_4  -0.0236241033  0.22100695  0.02117113</span></span>
<span><span class="co">#&gt; gene_noise_5  -0.0246378278 -0.18849671  0.63608275</span></span>
<span><span class="co">#&gt; gene_noise_6  -0.0037009439 -0.05526442  0.16294670</span></span>
<span><span class="co">#&gt; gene_noise_7  -0.0268014930  0.05081115 -0.69522057</span></span>
<span><span class="co">#&gt; gene_noise_8   0.0368993691  0.05205190  0.13542228</span></span>
<span><span class="co">#&gt; gene_noise_9   0.0002263975 -0.81355912 -0.21193486</span></span>
<span><span class="co">#&gt; gene_noise_10 -0.0038867809 -0.42682676  0.08440284</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for PC1</span></span>
<span><span class="va">pc2</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;       gene_2       gene_1 gene_noise_8 </span></span>
<span><span class="co">#&gt;   0.70534623   0.70530630   0.03689937</span></span></code></pre></div>
<p>Sidebar: sorting vectors using <code><a href="https://rdrr.io/r/base/order.html" class="external-link">order()</a></code></p>
<p>order return the sort order of a vector.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3 5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3 1 4 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2 4 1 3</span></span></code></pre></div>
<p>Useful shortcut to get vector sorted on the absolute values:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="op">-</span><span class="fl">9</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="op">-</span><span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vec</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">vec</span><span class="op">)</span>, </span>
<span>          decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] -10  10  -9   5   5  -3   2   0</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pc1</span> <span class="op">&lt;-</span> <span class="va">pc2</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> </span>
<span></span>
<span><span class="va">pc1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">pc1</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;       gene_2       gene_1 gene_noise_8 gene_noise_2 gene_noise_7 </span></span>
<span><span class="co">#&gt;   0.70534623   0.70530630   0.03689937   0.03192790  -0.02680149 </span></span>
<span><span class="co">#&gt; gene_noise_5 </span></span>
<span><span class="co">#&gt;  -0.02463783</span></span></code></pre></div>
<p>Using this approach we can quickly identify that <code>gene_1</code> and <code>gene_2</code> are driving the variance in the data.</p>
</div>
</div>
<div class="section level2">
<h2 id="run-pca-on-a-single-cell-dataset">Run PCA on a single cell dataset<a class="anchor" aria-label="anchor" href="#run-pca-on-a-single-cell-dataset"></a>
</h2>
<div class="section level3">
<h3 id="step-1-first-lets-filter-and-normalize-the-esc_mat-matrix-">Step 1: First let’s filter and normalize the <code>esc_mat</code> matrix.<a class="anchor" aria-label="anchor" href="#step-1-first-lets-filter-and-normalize-the-esc_mat-matrix-"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remove lowly expressed features (genes with non-zero values in at least 10 samples)</span></span>
<span><span class="va">filtered_mat</span> <span class="op">&lt;-</span> <span class="va">esc_mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">esc_mat</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">10</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># log normalize </span></span>
<span><span class="va">norm_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">filtered_mat</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">norm_mat</span> <span class="op">&lt;-</span> <span class="fl">10000</span> <span class="op">*</span> <span class="va">norm_mat</span></span>
<span><span class="va">norm_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">norm_mat</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-scale-the-data-">Step 2: Scale the data.<a class="anchor" aria-label="anchor" href="#step-2-scale-the-data-"></a>
</h3>
<p>This makes every variable equal in weight. For example if one variable ranges from -100 to 100, this variable will have more weight than one that ranges from -1 to 1. Often in most datasets scaling the variables is necessary to avoid projecting the PCA solely based on the abundance of a variable.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># scale and center each gene</span></span>
<span><span class="va">zmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">norm_mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-run-pca">Step 3: run PCA<a class="anchor" aria-label="anchor" href="#step-3-run-pca"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run PCA with genes as columns and cells as rows</span></span>
<span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">zmat</span><span class="op">)</span>, </span>
<span>             center <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>             scale. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-4-examine-variance-explained-by-each-pc">Step 4: Examine variance explained by each PC<a class="anchor" aria-label="anchor" href="#step-4-examine-variance-explained-by-each-pc"></a>
</h3>
<p>Exercise: make a ggplot plot that plots PC versus percent variance explained</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pc_var</span> <span class="op">&lt;-</span> <span class="va">pc</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">pc_var</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">pc_var</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pc_var</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  var_explained <span class="op">=</span> <span class="va">pc_var</span>,</span>
<span>  PC <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pc_var</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plt_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC</span>, </span>
<span>                    y <span class="op">=</span> <span class="va">var_explained</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-22-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="step-5-plot-pcs">Step 5: Plot PCs<a class="anchor" aria-label="anchor" href="#step-5-plot-pcs"></a>
</h3>
<p>Exercise: Generate a ggplot plot that plots PC1 versus PC2 and color by developmental stage. (i.e. zy, 4cell, 8cell, etc.)</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pc_mat</span> <span class="op">&lt;-</span> <span class="va">pc</span><span class="op">$</span><span class="va">x</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/slowkow/ggrepel" class="external-link">ggrepel</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pc_mat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">PC1</span>, <span class="va">PC2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">sample</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: ggrepel: 50 unlabeled data points (too many overlaps). Consider</span></span>
<span><span class="co">#&gt; increasing max.overlaps</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-23-1.png" width="480" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">pc_mat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html" class="external-link">separate</a></span><span class="op">(</span><span class="va">sample</span>, </span>
<span>           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"rep"</span><span class="op">)</span>,</span>
<span>           sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">PC1</span>, <span class="va">PC2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">time</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-23-2.png" width="480" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="kmeans-cluster-the-data">kmeans cluster the data<a class="anchor" aria-label="anchor" href="#kmeans-cluster-the-data"></a>
</h3>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">km</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">pc_mat</span>, centers <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">km_clusters</span> <span class="op">&lt;-</span> <span class="va">km</span><span class="op">$</span><span class="va">cluster</span></span>
<span></span>
<span><span class="va">tidy_clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">km_clusters</span><span class="op">)</span>,</span>
<span>  cluster <span class="op">=</span> <span class="va">km_clusters</span></span>
<span><span class="op">)</span></span>
<span><span class="va">tidy_clusters</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 72 × 2</span></span></span>
<span><span class="co">#&gt;    sample       cluster</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> zy_1               4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> zy_2               4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> zy_3               4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> zy_4               4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> early2cell_1       4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> early2cell_2       4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> early2cell_3       4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> early2cell_4       4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> early2cell_5       4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> early2cell_6       4</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 62 more rows</span></span></span>
<span></span>
<span><span class="va">plt_dat</span> <span class="op">&lt;-</span> <span class="va">pc_mat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">tidy_clusters</span>, by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plt_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">PC1</span>, <span class="va">PC2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-9_files/figure-html/unnamed-chunk-24-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="step-6-find-genes-that-are-associated-with-each-pc">Step 6: Find genes that are associated with each PC<a class="anchor" aria-label="anchor" href="#step-6-find-genes-that-are-associated-with-each-pc"></a>
</h3>
<p>For example we can see that PC1 separates that data along the developmental time. If we find genes with strongly positive loadings these should be genes that increase over time.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># find the top 25 genes that have the most positive and the most negative loadings for PC1</span></span>
<span></span>
<span><span class="va">pc1</span> <span class="op">&lt;-</span> <span class="va">pc</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">top25</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">pc1</span>,</span>
<span>              decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span></span>
<span><span class="va">bottom25</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">pc1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span></span>
<span></span>
<span><span class="va">top_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">top25</span>, <span class="va">bottom25</span><span class="op">)</span></span></code></pre></div>
<p>Exercise: Make a heatmap that plots the pc1_genes</p>
<p><img src="class-9_files/figure-html/unnamed-chunk-26-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="additional-exercise">Additional exercise<a class="anchor" aria-label="anchor" href="#additional-exercise"></a>
</h2>
<p>There is another dataset called <code>tx_rates</code> in the <code>pbda</code> package. This dataset contains transcription rates of mouse dendritic cells after exposure to LPS. Run PCA on this dataset to investigate the relationships between the different sampled time points. First remove genes (rows) with all zero values and remove rows that have zero variance (<code><a href="https://rdrr.io/pkg/matrixStats/man/rowVars.html" class="external-link">matrixStats::rowVars</a></code>) then log transform the data prior to scaling.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>An R package developed by the <a href="https://medschool.cuanschutz.edu/rbi" class="external-link">RNA Bioscience Initiative</a></p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
