<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="pbda">
<title>Class 8: Heatmaps and Clustering • pbda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><link href="../deps/_Source%20Sans%20Pro-0.4.1/font.css" rel="stylesheet">
<link href="../deps/_Source%20Code%20Pro-0.4.1/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Class 8: Heatmaps and Clustering">
<meta property="og:description" content="pbda">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="rnabioco.github.io" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">pbda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">Home</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-class-material">Class Material</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-class-material">
    <a class="dropdown-item" href="../articles/class-1.html">Class 1: Overview, Data Import and Tidying</a>
    <a class="dropdown-item" href="../articles/class-2.html">Class 2: Analyzing qPCR data</a>
    <a class="dropdown-item" href="../articles/class-5.html">Class 5: Basic Data Types and Structures</a>
    <a class="dropdown-item" href="../articles/class-6.html">Class 6: Writing Functions</a>
    <a class="dropdown-item" href="../articles/class-7.html">Class 7: Iteration</a>
    <a class="dropdown-item" href="../articles/class-8.html">Class 8: Heatmaps and Clustering</a>
    <a class="dropdown-item" href="../articles/class-9.html">Class 9: Exploring data with PCA</a>
    <a class="dropdown-item" href="../articles/class-10.html">Class 10: Jumping into more complex R, tips, resources</a>
    <a class="dropdown-item" href="../articles/class-11.html">Class 11: RNA-seq Analysis</a>
    <a class="dropdown-item" href="../articles/class-12.html">Class 12: Working with gene lists</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/assignments.html">Assignment Submission and Grading Rubric</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rnabioco/practical-data-analysis/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Class 8: Heatmaps and Clustering</h1>
                        <h4 data-toc-skip class="author">Kent Riemondy</h4>
            
            <h4 data-toc-skip class="date">2022-07-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rnabioco/practical-data-analysis/blob/HEAD/vignettes/class-8.Rmd" class="external-link"><code>vignettes/class-8.Rmd</code></a></small>
      <div class="d-none name"><code>class-8.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap" class="external-link">ComplexHeatmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rnabioco/practical-data-analysis" class="external-link">pbda</a></span><span class="op">)</span></span></code></pre></div>
<p>Goals:</p>
<ol style="list-style-type: decimal">
<li><p>Learn additional operations on matrices.</p></li>
<li><p>Demonstrate principles to effectively visualize large datasets with heatmaps.</p></li>
<li><p>Use clustering algorithms to identify patterns in the data.</p></li>
<li><p>Exploring datasets with PCA</p></li>
</ol>
<div class="section level3">
<h3 id="dataset-description">Dataset description<a class="anchor" aria-label="anchor" href="#dataset-description"></a>
</h3>
<p>For some of the exercises today we will be using a single cell RNA-seq dataset that is part of the <code>pbda</code> package. The <code>esc_mat</code> matrix contains read counts for each gene in each cell. The read counts are an abundance measurement for mRNAs in each cell.</p>
<p>This dataset contains 72 cells from mouse embryos at various stages of development (<a href="http://science.sciencemag.org/content/343/6167/193" class="external-link">Single-Cell RNA-Seq Reveals Dynamic, Random Monoallelic Gene Expression in Mammalian Cells</a>). This dataset, as well as many others are available in a preprocessed form from the Hemberg lab ( <a href="https://hemberg-lab.github.io/scRNA.seq.datasets/" class="external-link uri">https://hemberg-lab.github.io/scRNA.seq.datasets/</a>). Note that the number of cells has been reduced for complexity reasons.</p>
</div>
<div class="section level3">
<h3 id="apply-functions-per-row-or-per-column-of-a-matrix">Apply functions per row or per column of a matrix<a class="anchor" aria-label="anchor" href="#apply-functions-per-row-or-per-column-of-a-matrix"></a>
</h3>
<p>A common task with matrices is to compute a row-wise or column-wise summary. Tidyverse verbs don’t naively support operations on matrices. base R provides some useful summary functions, as well as the <code>matrixStats</code> package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">esc_mat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;         zy_1         zy_2         zy_3         zy_4 early2cell_1 </span></span>
<span><span class="co">#&gt;     30093033     25116127     31954663     17473603     22633227 </span></span>
<span><span class="co">#&gt; early2cell_2 </span></span>
<span><span class="co">#&gt;     23554335</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">esc_mat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Hvcn1   Gbp7 Arrdc1  Ercc5 Mrpl15  Dclk1 </span></span>
<span><span class="co">#&gt;  41740  15218  98903  19919 156510     42</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">esc_mat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;       zy_1             zy_2             zy_3       </span></span>
<span><span class="co">#&gt;  Min.   :     0   Min.   :     0   Min.   :     0  </span></span>
<span><span class="co">#&gt;  1st Qu.:     0   1st Qu.:     0   1st Qu.:     0  </span></span>
<span><span class="co">#&gt;  Median :     4   Median :    17   Median :    12  </span></span>
<span><span class="co">#&gt;  Mean   :  1342   Mean   :  1120   Mean   :  1425  </span></span>
<span><span class="co">#&gt;  3rd Qu.:   614   3rd Qu.:   527   3rd Qu.:   650  </span></span>
<span><span class="co">#&gt;  Max.   :290222   Max.   :188065   Max.   :269403</span></span></code></pre></div>
<p>There are a few base R plotting functions that are very useful for exploratory analysis with matrices. For example the <code><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist()</a></code> function can be used to quickly generate a histogram from a matrix. Various clustering functions also provide a <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method that can produce useful summaries. Often I use base R plots for interactive work, then use ggplot (or heatmaps) to make focused publication quality figures.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">esc_mat</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="apply-family-of-functions">Apply family of functions<a class="anchor" aria-label="anchor" href="#apply-family-of-functions"></a>
</h3>
<p>How would we apply an arbitrary function to operate row-wise or column-wise?</p>
<p>In base R there is a function called <code>apply</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">apply</span></span></code></pre></div>
<p>We can use apply to calculate rowSums and colSums.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">esc_mat</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Hvcn1   Gbp7 Arrdc1  Ercc5 Mrpl15  Dclk1 </span></span>
<span><span class="co">#&gt;  41740  15218  98903  19919 156510     42</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">esc_mat</span>, <span class="fl">2</span>, <span class="va">sum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;         zy_1         zy_2         zy_3         zy_4 early2cell_1 </span></span>
<span><span class="co">#&gt;     30093033     25116127     31954663     17473603     22633227 </span></span>
<span><span class="co">#&gt; early2cell_2 </span></span>
<span><span class="co">#&gt;     23554335</span></span></code></pre></div>
<p>We can also define custom functions and use them in apply. (See also <code>lapply</code>, <code>vapply</code>, <code>sapply</code>, etc. for variants for operating on different data structures)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#predefine function</span></span>
<span><span class="va">my_sum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fl">42</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">esc_mat</span>, <span class="fl">1</span>, <span class="va">my_sum</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ex</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;  Hvcn1   Gbp7 Arrdc1  Ercc5 Mrpl15 </span></span>
<span><span class="co">#&gt;  41782  15260  98945  19961 156552</span></span>
<span></span>
<span><span class="co"># or use an anonymous function </span></span>
<span><span class="va">ex2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">esc_mat</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">+</span> <span class="fl">42</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ex2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;  Hvcn1   Gbp7 Arrdc1  Ercc5 Mrpl15 </span></span>
<span><span class="co">#&gt;  41782  15260  98945  19961 156552</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="filtering-a-matrix-to-exclude-noisy-low-abundance-genes">Filtering a matrix to exclude noisy low-abundance genes<a class="anchor" aria-label="anchor" href="#filtering-a-matrix-to-exclude-noisy-low-abundance-genes"></a>
</h3>
<p>Next we are going to remove genes (rows) with low values from the <code>esc_mat</code> matrix and save this smaller matrix as <code>filtered_mat</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">to_keep</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">esc_mat</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">filtered_mat</span> <span class="op">&lt;-</span> <span class="va">esc_mat</span><span class="op">[</span><span class="va">to_keep</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">filtered_mat</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 14635</span></span>
<span><span class="co"># or alternatively</span></span></code></pre></div>
<p>or using <code>apply</code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">esc_mat</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">10</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filtered_mat</span> <span class="op">&lt;-</span> <span class="va">esc_mat</span><span class="op">[</span><span class="va">to_keep</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">filtered_mat</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 14635</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="normalizing-data">Normalizing data<a class="anchor" aria-label="anchor" href="#normalizing-data"></a>
</h3>
</div>
<div class="section level3">
<h3 id="exercise">Exercise<a class="anchor" aria-label="anchor" href="#exercise"></a>
</h3>
<p>Normalize each the expression values for each cell. Divide each column by the total number of counts in each column, multiply by 10000, and log transform (use the <code>log1p</code> function). Save the new matrix as <code>norm_mat</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># normalize a matrix</span></span>
<span><span class="va">norm_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">esc_mat</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">norm_mat</span> <span class="op">&lt;-</span> <span class="fl">10000</span> <span class="op">*</span> <span class="va">norm_mat</span></span>
<span><span class="va">norm_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">norm_mat</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># or log1p(norm_mat)</span></span>
<span></span>
<span></span>
<span><span class="co"># another approach </span></span>
<span><span class="va">lognorm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vec</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">norm_values</span> <span class="op">&lt;-</span> <span class="fl">10000</span> <span class="op">*</span> <span class="op">(</span><span class="va">vec</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">vec</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">norm_values</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">norm_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">esc_mat</span>, <span class="fl">2</span>, <span class="va">lognorm</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="converting-matrices-to-data-frames-and-tibbles">Converting matrices to data.frames and tibbles<a class="anchor" aria-label="anchor" href="#converting-matrices-to-data-frames-and-tibbles"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># to data.frame</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">esc_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># to tibble</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">df</span>, rownames <span class="op">=</span> <span class="st">"gene"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 6</span></span></span>
<span><span class="co">#&gt;   gene    zy_1  zy_2  zy_3  zy_4 early2cell_1</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Hvcn1   <span style="text-decoration: underline;">3</span>204  <span style="text-decoration: underline;">2</span>290  <span style="text-decoration: underline;">2</span>995  <span style="text-decoration: underline;">1</span>600         <span style="text-decoration: underline;">2</span>352</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Gbp7    <span style="text-decoration: underline;">1</span>101   719   473   533          594</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Arrdc1  <span style="text-decoration: underline;">3</span>574  <span style="text-decoration: underline;">2</span>269  <span style="text-decoration: underline;">2</span>481  <span style="text-decoration: underline;">1</span>478          920</span></span>
<span></span>
<span><span class="co"># or equivalently</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames_to_column</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"gene"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 6</span></span></span>
<span><span class="co">#&gt;   gene    zy_1  zy_2  zy_3  zy_4 early2cell_1</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Hvcn1   <span style="text-decoration: underline;">3</span>204  <span style="text-decoration: underline;">2</span>290  <span style="text-decoration: underline;">2</span>995  <span style="text-decoration: underline;">1</span>600         <span style="text-decoration: underline;">2</span>352</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Gbp7    <span style="text-decoration: underline;">1</span>101   719   473   533          594</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Arrdc1  <span style="text-decoration: underline;">3</span>574  <span style="text-decoration: underline;">2</span>269  <span style="text-decoration: underline;">2</span>481  <span style="text-decoration: underline;">1</span>478          920</span></span>
<span></span>
<span><span class="co"># as one step </span></span>
<span><span class="va">tbl_data</span> <span class="op">&lt;-</span> <span class="va">esc_mat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"gene"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl_data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 5</span></span></span>
<span><span class="co">#&gt;   gene    zy_1  zy_2  zy_3  zy_4</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Hvcn1   <span style="text-decoration: underline;">3</span>204  <span style="text-decoration: underline;">2</span>290  <span style="text-decoration: underline;">2</span>995  <span style="text-decoration: underline;">1</span>600</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Gbp7    <span style="text-decoration: underline;">1</span>101   719   473   533</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Arrdc1  <span style="text-decoration: underline;">3</span>574  <span style="text-decoration: underline;">2</span>269  <span style="text-decoration: underline;">2</span>481  <span style="text-decoration: underline;">1</span>478</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Ercc5   <span style="text-decoration: underline;">1</span>391  <span style="text-decoration: underline;">1</span>601  <span style="text-decoration: underline;">1</span>549   779</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Mrpl15     0    42     0    49</span></span></code></pre></div>
<p>Converting data.frames to matrices is also easily accomplished using <code><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix()</a></code></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl_mat</span> <span class="op">&lt;-</span> <span class="va">tbl_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">tbl_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tbl_mat</span><span class="op">$</span><span class="va">gene</span></span>
<span><span class="va">tbl_mat</span> <span class="op">&lt;-</span> <span class="va">tbl_mat</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">tbl_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">tbl_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;        zy_1 zy_2 zy_3</span></span>
<span><span class="co">#&gt; Hvcn1  3204 2290 2995</span></span>
<span><span class="co">#&gt; Gbp7   1101  719  473</span></span>
<span><span class="co">#&gt; Arrdc1 3574 2269 2481</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">tbl_mat</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "matrix" "array"</span></span>
<span></span>
<span><span class="co"># in one step</span></span>
<span><span class="va">tbl_mat</span> <span class="op">&lt;-</span> <span class="va">tbl_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">column_to_rownames</a></span><span class="op">(</span><span class="st">"gene"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Converting vectors to tibbles is also very useful.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make a vector from colnames</span></span>
<span><span class="va">col_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tbl_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#build tibble directly</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>sample_names <span class="op">=</span> <span class="va">col_ids</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 72 × 1</span></span></span>
<span><span class="co">#&gt;    sample_names</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> zy_1        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> zy_2        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> zy_3        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> zy_4        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> early2cell_1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> early2cell_2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> early2cell_3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> early2cell_4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> early2cell_5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> early2cell_6</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 62 more rows</span></span></span>
<span></span>
<span><span class="co">#additional columns can be added as long as all of the vectors are the same length</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>sample_names <span class="op">=</span> <span class="va">col_ids</span>,</span>
<span>       id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">72</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 72 × 2</span></span></span>
<span><span class="co">#&gt;    sample_names    id</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> zy_1             1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> zy_2             2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> zy_3             3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> zy_4             4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> early2cell_1     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> early2cell_2     6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> early2cell_3     7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> early2cell_4     8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> early2cell_5     9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> early2cell_6    10</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 62 more rows</span></span></span></code></pre></div>
<p>generating data.frames</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sample_names <span class="op">=</span> <span class="va">col_ids</span>,</span>
<span>           id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">72</span>,</span>
<span>           stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># very important</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exercise-1">Exercise<a class="anchor" aria-label="anchor" href="#exercise-1"></a>
</h3>
<p>Tidy the <code>norm_mat</code> matrix into long format and extract out the timepoint information from the column name (e.g. <code>zy</code>, <code>early2cell</code>, etc.). Plot the expression values for each time point (<code>geom_violin</code> or <code>geom_boxplot</code>).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tidy_mat</span> <span class="op">&lt;-</span> <span class="va">norm_mat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"gene"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">gene</span>, names_to <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html" class="external-link">separate</a></span><span class="op">(</span><span class="va">sample</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"timepoint"</span>, <span class="st">"rep"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">tidy_mat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">timepoint</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span><span class="op">)</span> </span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="generating-heatmaps-using-complexheatmap">Generating Heatmaps using ComplexHeatmap<a class="anchor" aria-label="anchor" href="#generating-heatmaps-using-complexheatmap"></a>
</h2>
<p>How do we visualize this dataset to examine relationships between samples? Visualizing the entire matrix will be computationally expensive and likely completely unintepretable as it will obscure interesting patterns. Ideally we’d like to reduce the dataset to less than a few thousand genes for visualization.</p>
<p>How do we select which features to plot in a heatmap?</p>
<ol style="list-style-type: decimal">
<li><p>Use statistics to find features that are significant based on some hypothesis (i.e. run <code>DESeq2</code> for RNA-seq).</p></li>
<li><p>Pick features of interest related to the hypothesis.</p></li>
<li><p>Select features with high variance. Low variance features are probably not very interesting</p></li>
<li><p>Down sample the matrix to a smaller size</p></li>
</ol>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_variance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">norm_mat</span>, <span class="fl">1</span>, <span class="va">var</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># top 30 most variable genes</span></span>
<span><span class="va">vargenes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gene_variance</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">vargenes</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Zbed3"        "LOC100502936" "C86187"       "Btg4"        </span></span>
<span><span class="co">#&gt; [5] "Alppl2"       "Tcl1"</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var_mat</span> <span class="op">&lt;-</span> <span class="va">norm_mat</span><span class="op">[</span><span class="va">vargenes</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">var_mat</span>, </span>
<span>        name <span class="op">=</span> <span class="st">"log scale"</span>,</span>
<span>        cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        cluster_columns <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Use clustering techniques to naturally order the data.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var_mat</span> <span class="op">&lt;-</span> <span class="va">norm_mat</span><span class="op">[</span><span class="va">vargenes</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">var_mat</span>, </span>
<span>        name <span class="op">=</span> <span class="st">"log scale"</span>,</span>
<span>        cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        cluster_columns <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Often visualizing gene expression abundance can obscure some patterns, as lower expression values are not as strongly represented. A common data transformation is mean-centering and scaling each gene. This is also known as a z-score.</p>
<p><code>(x - mean(x)) / sd(x)</code></p>
<p>By generating z-scores, the gene expression data now represents standard deviations away from the mean. A built in function in R called <code>scale</code> can generate z-scores. This is also easy to do using an apply function.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">scale</span></span></code></pre></div>
<p>The scale function performs scaling per <strong>column</strong> in a matrix. However, it is common in genomics for matrices to be represented with samples (i.e. cells) as columns and genes as rows. This is done as commonly the number of genes (i.e. features) is much greater than the number of samples, and so it is conviently (and computationally easier) to represent data in this format.</p>
<p>However, is this a tidy format?</p>
<p>Are the variables stored as rows or columns?</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;                  zy_1     zy_2     zy_3</span></span>
<span><span class="co">#&gt; Zbed3        4.579253 4.329129 4.446267</span></span>
<span><span class="co">#&gt; LOC100502936 3.995553 4.024628 4.060731</span></span>
<span><span class="co">#&gt; C86187       3.900258 3.914178 4.026102</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">var_mat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;         Zbed3 LOC100502936   C86187</span></span>
<span><span class="co">#&gt; zy_1 4.579253     3.995553 3.900258</span></span>
<span><span class="co">#&gt; zy_2 4.329129     4.024628 3.914178</span></span>
<span><span class="co">#&gt; zy_3 4.446267     4.060731 4.026102</span></span>
<span></span>
<span></span>
<span><span class="va">zmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">var_mat</span><span class="op">)</span>, </span>
<span>                center <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># confirm that columns are the same after scaling</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">zmat</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">var_mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">zmat</span>, </span>
<span>        name <span class="op">=</span> <span class="st">"z-score"</span>,</span>
<span>        cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        cluster_columns <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Multiple heatmaps can be generated and plotted together if they share genes. For example, if we wanted to compare the zscore values to the log expression values.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># save each heatmap as an object</span></span>
<span><span class="va">h1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">zmat</span>, </span>
<span>        name <span class="op">=</span> <span class="st">"z-score"</span>,</span>
<span>        cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        cluster_columns <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">h2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">var_mat</span>,</span>
<span>        name <span class="op">=</span> <span class="st">"log"</span>,</span>
<span>        cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        cluster_columns <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use the + operator to combine</span></span>
<span><span class="va">h1</span> <span class="op">+</span> <span class="va">h2</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-20-1.png" width="1344" style="display: block; margin: auto;"></p>
<p>Heatmaps can be saved in a variety of formats using built in r functions, <code>pdf</code>, <code>png</code>, <code>svg</code>, and <code>jpeg</code>. <code>ggplots</code> plots can be saved with <code>ggsave</code> or the cowplot wrapper <code>save_plot</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"figure1.pdf"</span><span class="op">)</span> <span class="co"># name of plot</span></span>
<span>  <span class="va">h1</span> <span class="op">+</span> <span class="va">h2</span> <span class="co"># code that generates the plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># saves the plot</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="st">"figure1.png"</span><span class="op">)</span> </span>
<span>  <span class="va">h1</span> <span class="op">+</span> <span class="va">h2</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/cairo.html" class="external-link">svg</a></span><span class="op">(</span><span class="st">"figure1.svg"</span><span class="op">)</span> </span>
<span>  <span class="va">h1</span> <span class="op">+</span> <span class="va">h2</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">tiff</a></span><span class="op">(</span><span class="st">"figure1.tiff"</span><span class="op">)</span> </span>
<span>  <span class="va">h1</span> <span class="op">+</span> <span class="va">h2</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span> </span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">mpg</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/save_plot.html" class="external-link">save_plot</a></span><span class="op">(</span><span class="st">"mtcars.pdf"</span>, <span class="va">p</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="exercises">Exercises<a class="anchor" aria-label="anchor" href="#exercises"></a>
</h3>
<p>Create a heatmap containing the top 200 variables genes, using log normalized data. Consult the help menu (?Heatmap) to generate a heatmap and save it to a file.</p>
<p>Your heatmap should be made in the following manner:</p>
<ol style="list-style-type: decimal">
<li>cluster by row</li>
<li>hide the rownames</li>
<li>add a title to the legend</li>
<li>add a title to the columns</li>
</ol>
<p>What appears to be happening between the <code>early2cell</code> and <code>mid2cell</code> stages?</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_variance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">norm_mat</span>, <span class="fl">1</span>, <span class="va">var</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vargenes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gene_variance</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span><span class="op">]</span></span>
<span></span>
<span><span class="va">var_mat</span> <span class="op">&lt;-</span> <span class="va">norm_mat</span><span class="op">[</span><span class="va">vargenes</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">var_mat</span>, </span>
<span>        name <span class="op">=</span> <span class="st">"log scale"</span>,</span>
<span>        cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        show_row_names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        column_title <span class="op">=</span> <span class="st">"Samples"</span>, </span>
<span>        row_title <span class="op">=</span> <span class="st">"Genes"</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-23-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="clustering">Clustering<a class="anchor" aria-label="anchor" href="#clustering"></a>
</h2>
<p>Reviews:</p>
<ul>
<li><p><a href="http://stke.sciencemag.org/content/9/432/re6" class="external-link">Avoiding common pitfalls when clustering biological data</a></p></li>
<li><p><a href="https://www.nature.com/articles/nbt1205-1499" class="external-link">How does gene expression clustering work?</a></p></li>
<li><p><a href="https://www.nature.com/articles/nmeth.1902" class="external-link">Heatmaps</a><br></p></li>
<li><p><a href="http://www.opiniomics.org/you-probably-dont-understand-heatmaps/" class="external-link">blog post: You probably don’t understand heatmaps</a> by Mick Watson.</p></li>
</ul>
<p>By default many Heatmap packages perform clustering to aid in identifying patterns in the data.</p>
<p>We can see the euclidean distances between samples using <code>dist</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">var_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   zy_1      zy_2      zy_3      zy_4</span></span>
<span><span class="co">#&gt; zy_2         0.2951908                              </span></span>
<span><span class="co">#&gt; zy_3         0.2006237 0.2611443                    </span></span>
<span><span class="co">#&gt; zy_4         0.3590522 0.1513323 0.3747836          </span></span>
<span><span class="co">#&gt; early2cell_1 1.2826717 1.0289290 1.1796294 0.9800686</span></span></code></pre></div>
<p>The hierarchical clustering is performed by default in ComplexHeatmap using <code>hclust</code> with the output of <code>dist</code> as input. <code>hclust</code> provides a plotting method using <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> to visualized the results as a dendogram.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html" class="external-link">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">var_mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hc</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-25-1.png" width="672" style="display: block; margin: auto;"></p>
<p>We can change the distance metric used for the Heatmap by changing the <code>clustering_distance_rows</code> argument. A correlation measure, for example <code>Spearman</code>, is not sensitive to abundance, and can recover the shared patterns in the data.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">var_mat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"spearman"</span><span class="op">)</span></span>
<span><span class="co">#&gt;              zy_1 zy_2 zy_3 zy_4 early2cell_1</span></span>
<span><span class="co">#&gt; zy_1          1.0  1.0  1.0  0.9          0.3</span></span>
<span><span class="co">#&gt; zy_2          1.0  1.0  1.0  0.9          0.3</span></span>
<span><span class="co">#&gt; zy_3          1.0  1.0  1.0  0.9          0.3</span></span>
<span><span class="co">#&gt; zy_4          0.9  0.9  0.9  1.0          0.4</span></span>
<span><span class="co">#&gt; early2cell_1  0.3  0.3  0.3  0.4          1.0</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use pretty colors</span></span>
<span><span class="va">vcols</span> <span class="op">&lt;-</span> <span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">var_mat</span>, </span>
<span>        col <span class="op">=</span> <span class="va">vcols</span>,</span>
<span>        clustering_distance_rows <span class="op">=</span> <span class="st">"spearman"</span>,</span>
<span>        cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>        cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        show_row_names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-27-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Heatmaps are also very useful for quickly examining the similarities between samples</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cor_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">var_mat</span>, method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">cor_mat</span>,</span>
<span>        col <span class="op">=</span> <span class="va">vcols</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-28-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="section level3">
<h3 id="extracting-out-clusters">Extracting out clusters<a class="anchor" aria-label="anchor" href="#extracting-out-clusters"></a>
</h3>
<p>How do we select out individual clusters from hierachical clustering? How do we define clusters?</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">var_mat</span>, </span>
<span>              col <span class="op">=</span> <span class="va">vcols</span>,</span>
<span>              name <span class="op">=</span> <span class="st">"log scale"</span>,</span>
<span>        cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        show_row_names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        row_title <span class="op">=</span> <span class="st">"Genes"</span><span class="op">)</span></span>
<span><span class="va">h1</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-29-1.png" width="672" style="display: block; margin: auto;"></p>
<p>First let’s generate the dendogram:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html" class="external-link">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="va">var_mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hc</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-30-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Next we can use <code><a href="https://rdrr.io/r/stats/cutree.html" class="external-link">cutree()</a></code> to cut the tree into groups</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">cutree</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># split into 5 groups</span></span>
<span><span class="va">kclusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html" class="external-link">cutree</a></span><span class="op">(</span><span class="va">hc</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hc</span>, labels <span class="op">=</span> <span class="va">kclusters</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-32-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># split based on height of tree</span></span>
<span><span class="va">hclusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cutree.html" class="external-link">cutree</a></span><span class="op">(</span><span class="va">hc</span>, h <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hc</span>, labels <span class="op">=</span> <span class="va">hclusters</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-32-2.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">hclusters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;        Zbed3 LOC100502936       C86187         Btg4       Alppl2 </span></span>
<span><span class="co">#&gt;            1            1            1            1            2</span></span></code></pre></div>
<p>Now that we have assigned clusters we can replot our heatmaps split out by each cluster, using the <code>split</code> argument.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">var_mat</span>,</span>
<span>              col <span class="op">=</span> <span class="va">vcols</span>, </span>
<span>              name <span class="op">=</span> <span class="st">"log scale"</span>,</span>
<span>              cluster_rows <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>              show_row_names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              split <span class="op">=</span> <span class="va">kclusters</span>, </span>
<span>              row_title <span class="op">=</span> <span class="st">"Genes"</span><span class="op">)</span></span>
<span><span class="va">h1</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-33-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="k-means">K-means<a class="anchor" aria-label="anchor" href="#k-means"></a>
</h3>
<p>K-means clustering is another simple, yet powerful clustering techinuqe. It also scales to much larger datasets than hierarchical clustering.</p>
<ul>
<li><p><a href="http://onmyphd.com/?p=k-means.clustering" class="external-link">interactive description</a></p></li>
<li><p><a href="https://en.wikipedia.org/wiki/K-means_clustering" class="external-link">detailed description</a></p></li>
<li><p><a href="https://stackoverflow.com/questions/15376075/cluster-analysis-in-r-determine-the-optimal-number-of-clusters" class="external-link">determining number of clusters</a></p></li>
</ul>
<p>Kmeans is easily implemented using <code><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans()</a></code></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">var_mat</span>, centers <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clusters</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "cluster"      "centers"      "totss"        "withinss"    </span></span>
<span><span class="co">#&gt; [5] "tot.withinss" "betweenss"    "size"         "iter"        </span></span>
<span><span class="co">#&gt; [9] "ifault"</span></span></code></pre></div>
<p>Cluster assignments can be extracted using <code>$cluster</code></p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clusters</span><span class="op">$</span><span class="va">cluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;        Zbed3 LOC100502936       C86187         Btg4       Alppl2 </span></span>
<span><span class="co">#&gt;            3            3            3            3            5 </span></span>
<span><span class="co">#&gt;         Tcl1 </span></span>
<span><span class="co">#&gt;            3</span></span></code></pre></div>
<p>To recover a reproducible kmeans classification set a seed for the random number generator</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">var_mat</span>, centers <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">clusters</span><span class="op">$</span><span class="va">cluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;        Zbed3 LOC100502936       C86187         Btg4       Alppl2 </span></span>
<span><span class="co">#&gt;            5            5            5            5            2 </span></span>
<span><span class="co">#&gt;         Tcl1 </span></span>
<span><span class="co">#&gt;            5</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exercise-2">Exercise:<a class="anchor" aria-label="anchor" href="#exercise-2"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Make a Heatmap split by each kmeans cluster</p></li>
<li><p>Use your tidying and ggplot skills to plot the gene expression values per cluster, by timepoint.</p></li>
</ol>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">km</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">var_mat</span>, centers <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">km_clusters</span> <span class="op">&lt;-</span> <span class="va">km</span><span class="op">$</span><span class="va">cluster</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span></span>
<span>  <span class="va">var_mat</span>, </span>
<span>  split <span class="op">=</span> <span class="va">km_clusters</span>,</span>
<span>  show_row_names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cluster_columns <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-37-1.png" width="1152" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  gene <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">km_clusters</span><span class="op">)</span>,</span>
<span>  cluster <span class="op">=</span> <span class="va">km_clusters</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tidy_mat</span> <span class="op">&lt;-</span> <span class="va">var_mat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"gene"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">tidy_mat</span>, </span>
<span>          <span class="va">cluster_df</span>,</span>
<span>          by <span class="op">=</span> <span class="st">"gene"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt_dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">zy_1</span><span class="op">:</span><span class="va">lateblast_4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">name</span>, <span class="st">"_[0-9]"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="op">~</span><span class="va">cluster</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="class-8_files/figure-html/unnamed-chunk-38-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>An R package developed by the <a href="https://medschool.cuanschutz.edu/rbi" class="external-link">RNA Bioscience Initiative</a></p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
