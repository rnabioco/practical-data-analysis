<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Class 7: Heatmaps and Clustering • pbda</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Class 7: Heatmaps and Clustering">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pbda</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Class Material
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/class-1.html">Class 1: Overview, Data Import and Tidying</a>
    </li>
    <li>
      <a href="../articles/class-2.html">Class 2: Analyzing qPCR data</a>
    </li>
    <li>
      <a href="../articles/class-5.html">Class 5: Basic Data Types and Structures</a>
    </li>
    <li class="divider">
    <li>
      <a href="../articles/assignments.html">Assignment Submission and Grading Rubric</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rnabioco/practical-data-analysis">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Class 7: Heatmaps and Clustering</h1>
                        <h4 class="author">Kent Riemondy</h4>
            
            <h4 class="date">2019-12-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rnabioco/practical-data-analysis/blob/master/vignettes/class-7.Rmd"><code>vignettes/class-7.Rmd</code></a></small>
      <div class="hidden name"><code>class-7.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">devtools<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">install_github</a></span>(<span class="st">"IDPT7810/practical-data-analysis"</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ComplexHeatmap)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(pbda)</a></code></pre></div>
<p>Goals:</p>
<ol style="list-style-type: decimal">
<li><p>Learn additional operations on matrices.</p></li>
<li><p>Demonstrate principles to effectively visualize large datasets with heatmaps.</p></li>
<li><p>Use clustering algorithms to identify patterns in the data.</p></li>
</ol>
<div id="matrix-operations" class="section level2">
<h2 class="hasAnchor">
<a href="#matrix-operations" class="anchor"></a>Matrix operations</h2>
<p>For some of the exercises today we will be using a single cell RNA-seq dataset that is part of the <code>pbda</code> package. For simplicity we will just use the raw matrix rather than working through a Seurat object. The <code>esc_mat</code> matrix contains raw read counts for each gene in each cell.</p>
<p>This dataset contains 72 cells from mouse embryos at various stages of development (<a href="http://science.sciencemag.org/content/343/6167/193">Single-Cell RNA-Seq Reveals Dynamic, Random Monoallelic Gene Expression in Mammalian Cells</a>). This dataset, as well as many others are available in a preprocessed form from the Hemberg lab ( <a href="https://hemberg-lab.github.io/scRNA.seq.datasets/" class="uri">https://hemberg-lab.github.io/scRNA.seq.datasets/</a>). Note that the number of cells has been reduced for complexity reasons.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">esc_mat[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#&gt;        zy_1 zy_2 zy_3</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#&gt; Hvcn1  3204 2290 2995</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co">#&gt; Gbp7   1101  719  473</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">#&gt; Arrdc1 3574 2269 2481</span></a></code></pre></div>
<p>Many mathmatical operations that work on vectors also work on matrices.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(esc_mat)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; [1] 950336593</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(esc_mat)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; [1] 0</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(esc_mat)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; [1] 290222</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(esc_mat)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; [1] 588.4321</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(esc_mat)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; [1] 0</span></a></code></pre></div>
<p>Logical comparisons also work. Note that the <code>.</code> is a placeholder that indicates the data being passed from the pipe.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(esc_mat) <span class="op">%&gt;%</span><span class="st"> </span>.[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt;         zy_1  zy_2  zy_3</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#&gt; Hvcn1  FALSE FALSE FALSE</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; Gbp7   FALSE FALSE FALSE</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; Arrdc1 FALSE FALSE FALSE</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co"># equivalently</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">na_values &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(esc_mat) </a>
<a class="sourceLine" id="cb4-9" data-line-number="9">na_values[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt;         zy_1  zy_2  zy_3</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; Hvcn1  FALSE FALSE FALSE</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#&gt; Gbp7   FALSE FALSE FALSE</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt; Arrdc1 FALSE FALSE FALSE</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">(esc_mat <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>.[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt;        zy_1 zy_2 zy_3</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt; Hvcn1  TRUE TRUE TRUE</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; Gbp7   TRUE TRUE TRUE</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">#&gt; Arrdc1 TRUE TRUE TRUE</span></a></code></pre></div>
<p>How many elements contain NA or zero values in the matrix? Note that <code>TRUE == 1</code> and <code>FALSE == 0</code></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="ot">TRUE</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span> </a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="ot">FALSE</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; [1] FALSE</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#&gt; [1] 2</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(esc_mat))</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co">#&gt; [1] 0</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(esc_mat <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">#&gt; [1] 704156</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(esc_mat <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(esc_mat)</a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="co">#&gt; [1] 0.4360013</span></a></code></pre></div>
<div id="apply-functions-per-row-or-per-column" class="section level3">
<h3 class="hasAnchor">
<a href="#apply-functions-per-row-or-per-column" class="anchor"></a>Apply functions per row or per column</h3>
<p>A common task with matrices is to compute a row-wise or column-wise summary. We have already used a few functions that perform these operations.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(esc_mat) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt;         zy_1         zy_2         zy_3         zy_4 early2cell_1 early2cell_2 </span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt;     30093033     25116127     31954663     17473603     22633227     23554335</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(esc_mat) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt;  Hvcn1   Gbp7 Arrdc1  Ercc5 Mrpl15  Dclk1 </span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt;  41740  15218  98903  19919 156510     42</span></a></code></pre></div>
<p>How would we apply an arbitrary function to operate row-wise or column-wise?</p>
<p>In base R there is a function called <code>apply</code>. There is no tidyverse equivalent for operating on matrices at this point.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">?apply</a></code></pre></div>
<p>We can use apply to calculate rowSums and colSums.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(esc_mat, <span class="dv">1</span>, sum) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#&gt;  Hvcn1   Gbp7 Arrdc1  Ercc5 Mrpl15  Dclk1 </span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt;  41740  15218  98903  19919 156510     42</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(esc_mat, <span class="dv">2</span>, sum) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt;         zy_1         zy_2         zy_3         zy_4 early2cell_1 early2cell_2 </span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">#&gt;     30093033     25116127     31954663     17473603     22633227     23554335</span></a></code></pre></div>
</div>
<div id="exercise" class="section level3">
<h3 class="hasAnchor">
<a href="#exercise" class="anchor"></a>Exercise</h3>
<p>Remove all genes with low expression from the <code>esc_mat</code> matrix. Save this new matrix as <code>norm_mat</code>. Keep genes that have greater than 10 samples with non-zero counts. How many genes remain?</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">genes_to_keep &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(esc_mat, <span class="dv">1</span>, </a>
<a class="sourceLine" id="cb9-3" data-line-number="3">                       <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co"># same result as above</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">genes_to_keep &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span>(esc_mat <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">filtered_mat &lt;-<span class="st"> </span>esc_mat[genes_to_keep, ]</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(filtered_mat)</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt; [1] 14635</span></a></code></pre></div>
<p>If the function has multiple arguments, there are two options to supply the arguments to apply.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co">#make a smaller matrix</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">mat &lt;-<span class="st"> </span>esc_mat[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(mat, <span class="dv">1</span>, sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#&gt;  Hvcn1   Gbp7 Arrdc1  Ercc5 Mrpl15  Dclk1  Tssc4  Gm101   Pum2   Erv3 </span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#&gt;  12441   3420  10722   6624     91     18    288     37  87487     21</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(mat, <span class="dv">1</span>, <span class="cf">function</span>(row) <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(row, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co">#&gt;  Hvcn1   Gbp7 Arrdc1  Ercc5 Mrpl15  Dclk1  Tssc4  Gm101   Pum2   Erv3 </span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co">#&gt;  12441   3420  10722   6624     91     18    288     37  87487     21</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co"># same as above</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(mat, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">#&gt;  Hvcn1   Gbp7 Arrdc1  Ercc5 Mrpl15  Dclk1  Tssc4  Gm101   Pum2   Erv3 </span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="co">#&gt;  12441   3420  10722   6624     91     18    288     37  87487     21</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co"># using a custom function</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">max_minus_min &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">  <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(x) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(x)</a>
<a class="sourceLine" id="cb10-21" data-line-number="21">}</a>
<a class="sourceLine" id="cb10-22" data-line-number="22"></a>
<a class="sourceLine" id="cb10-23" data-line-number="23"><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(mat, <span class="dv">2</span>, max_minus_min)</a>
<a class="sourceLine" id="cb10-24" data-line-number="24"><span class="co">#&gt;         zy_1         zy_2         zy_3         zy_4 early2cell_1 </span></a>
<a class="sourceLine" id="cb10-25" data-line-number="25"><span class="co">#&gt;        18810        16108        20938        12192        19439</span></a></code></pre></div>
</div>
<div id="exercise-1" class="section level3">
<h3 class="hasAnchor">
<a href="#exercise-1" class="anchor"></a>Exercise</h3>
<p>Normalize each the expression values for each cell. Divide each column by the total number of reads in each column, multiply by 10000, and log transform.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># normalize a matrix</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">norm_mat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(esc_mat, <span class="dv">2</span>, <span class="cf">function</span>(x) x <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(x)) </a>
<a class="sourceLine" id="cb11-3" data-line-number="3">norm_mat &lt;-<span class="st"> </span><span class="dv">10000</span> <span class="op">*</span><span class="st"> </span>norm_mat</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">norm_mat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(norm_mat <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="co"># or log1p(norm_mat)</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co"># another approach </span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">lognorm &lt;-<span class="st"> </span><span class="cf">function</span>(vec){</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">  norm_values &lt;-<span class="st"> </span><span class="dv">10000</span> <span class="op">*</span><span class="st"> </span>(vec <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(vec))</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">  <span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(norm_values <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb11-12" data-line-number="12"></a>
<a class="sourceLine" id="cb11-13" data-line-number="13">norm_mat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(esc_mat, <span class="dv">2</span>, lognorm)</a></code></pre></div>
</div>
<div id="converting-matrices-to-data-frames-and-tibbles" class="section level3">
<h3 class="hasAnchor">
<a href="#converting-matrices-to-data-frames-and-tibbles" class="anchor"></a>Converting matrices to data.frames and tibbles</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># to data.frame</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(mat)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">df[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt;        zy_1 zy_2 zy_3 zy_4 early2cell_1</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#&gt; Hvcn1  3204 2290 2995 1600         2352</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt; Gbp7   1101  719  473  533          594</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co">#&gt; Arrdc1 3574 2269 2481 1478          920</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co"># to tibble</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="kw">as_tibble</span>(df, <span class="dt">rownames =</span> <span class="st">"gene"</span>)</a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">#&gt; # A tibble: 10 x 6</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co">#&gt;    gene    zy_1  zy_2  zy_3  zy_4 early2cell_1</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co">#&gt;    &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;        &lt;int&gt;</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co">#&gt;  1 Hvcn1   3204  2290  2995  1600         2352</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#&gt;  2 Gbp7    1101   719   473   533          594</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co">#&gt;  3 Arrdc1  3574  2269  2481  1478          920</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">#&gt;  4 Ercc5   1391  1601  1549   779         1304</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="co">#&gt;  5 Mrpl15     0    42     0    49            0</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="co">#&gt;  6 Dclk1      1    17     0     0            0</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co">#&gt;  7 Tssc4     66    36    83   103            0</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="co">#&gt;  8 Gm101      0    19    11     4            3</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="co">#&gt;  9 Pum2   18810 16108 20938 12192        19439</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="co">#&gt; 10 Erv3       1     0     0     0           20</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="co"># or equivalently</span></a>
<a class="sourceLine" id="cb12-26" data-line-number="26"><span class="kw">rownames_to_column</span>(df, <span class="st">"gene"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>()</a>
<a class="sourceLine" id="cb12-27" data-line-number="27"><span class="co">#&gt; # A tibble: 10 x 6</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28"><span class="co">#&gt;    gene    zy_1  zy_2  zy_3  zy_4 early2cell_1</span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="co">#&gt;    &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;        &lt;int&gt;</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="co">#&gt;  1 Hvcn1   3204  2290  2995  1600         2352</span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="co">#&gt;  2 Gbp7    1101   719   473   533          594</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32"><span class="co">#&gt;  3 Arrdc1  3574  2269  2481  1478          920</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="co">#&gt;  4 Ercc5   1391  1601  1549   779         1304</span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34"><span class="co">#&gt;  5 Mrpl15     0    42     0    49            0</span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35"><span class="co">#&gt;  6 Dclk1      1    17     0     0            0</span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36"><span class="co">#&gt;  7 Tssc4     66    36    83   103            0</span></a>
<a class="sourceLine" id="cb12-37" data-line-number="37"><span class="co">#&gt;  8 Gm101      0    19    11     4            3</span></a>
<a class="sourceLine" id="cb12-38" data-line-number="38"><span class="co">#&gt;  9 Pum2   18810 16108 20938 12192        19439</span></a>
<a class="sourceLine" id="cb12-39" data-line-number="39"><span class="co">#&gt; 10 Erv3       1     0     0     0           20</span></a>
<a class="sourceLine" id="cb12-40" data-line-number="40"></a>
<a class="sourceLine" id="cb12-41" data-line-number="41"><span class="co"># as one step </span></a>
<a class="sourceLine" id="cb12-42" data-line-number="42"></a>
<a class="sourceLine" id="cb12-43" data-line-number="43">tbl_data &lt;-<span class="st"> </span>mat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>(<span class="dt">rownames =</span> <span class="st">"gene"</span>)</a>
<a class="sourceLine" id="cb12-44" data-line-number="44">tbl_data</a>
<a class="sourceLine" id="cb12-45" data-line-number="45"><span class="co">#&gt; # A tibble: 10 x 6</span></a>
<a class="sourceLine" id="cb12-46" data-line-number="46"><span class="co">#&gt;    gene    zy_1  zy_2  zy_3  zy_4 early2cell_1</span></a>
<a class="sourceLine" id="cb12-47" data-line-number="47"><span class="co">#&gt;    &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;        &lt;int&gt;</span></a>
<a class="sourceLine" id="cb12-48" data-line-number="48"><span class="co">#&gt;  1 Hvcn1   3204  2290  2995  1600         2352</span></a>
<a class="sourceLine" id="cb12-49" data-line-number="49"><span class="co">#&gt;  2 Gbp7    1101   719   473   533          594</span></a>
<a class="sourceLine" id="cb12-50" data-line-number="50"><span class="co">#&gt;  3 Arrdc1  3574  2269  2481  1478          920</span></a>
<a class="sourceLine" id="cb12-51" data-line-number="51"><span class="co">#&gt;  4 Ercc5   1391  1601  1549   779         1304</span></a>
<a class="sourceLine" id="cb12-52" data-line-number="52"><span class="co">#&gt;  5 Mrpl15     0    42     0    49            0</span></a>
<a class="sourceLine" id="cb12-53" data-line-number="53"><span class="co">#&gt;  6 Dclk1      1    17     0     0            0</span></a>
<a class="sourceLine" id="cb12-54" data-line-number="54"><span class="co">#&gt;  7 Tssc4     66    36    83   103            0</span></a>
<a class="sourceLine" id="cb12-55" data-line-number="55"><span class="co">#&gt;  8 Gm101      0    19    11     4            3</span></a>
<a class="sourceLine" id="cb12-56" data-line-number="56"><span class="co">#&gt;  9 Pum2   18810 16108 20938 12192        19439</span></a>
<a class="sourceLine" id="cb12-57" data-line-number="57"><span class="co">#&gt; 10 Erv3       1     0     0     0           20</span></a></code></pre></div>
<p>Converting data.frames to matrices is also easily accomplished using <code><a href="https://rdrr.io/r/base/matrix.html">as.matrix()</a></code></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">tbl_mat &lt;-<span class="st"> </span>tbl_data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>()</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(tbl_mat) &lt;-<span class="st"> </span>tbl_mat<span class="op">$</span>gene</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">tbl_mat &lt;-<span class="st"> </span>tbl_mat[, <span class="dv">-1</span>]</a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">tbl_mat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(tbl_mat)</a>
<a class="sourceLine" id="cb13-9" data-line-number="9"></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">tbl_mat[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co">#&gt;        zy_1 zy_2 zy_3</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co">#&gt; Hvcn1  3204 2290 2995</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co">#&gt; Gbp7   1101  719  473</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt; Arrdc1 3574 2269 2481</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(tbl_mat)</a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt; [1] "matrix"</span></a></code></pre></div>
<p>Converting vectors to tibbles is also very useful.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># make a vector from colnames</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">col_ids &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(tbl_mat)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co">#build tibble directly</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="kw">tibble</span>(<span class="dt">sample_names =</span> col_ids)</a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co">#&gt; # A tibble: 5 x 1</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co">#&gt;   sample_names</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="co">#&gt;   &lt;chr&gt;       </span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="co">#&gt; 1 zy_1        </span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="co">#&gt; 2 zy_2        </span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="co">#&gt; 3 zy_3        </span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="co">#&gt; 4 zy_4        </span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="co">#&gt; 5 early2cell_1</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="co">#additional columns can be added as long as all of the vectors are the same lenght</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="kw">tibble</span>(<span class="dt">sample_names =</span> col_ids,</a>
<a class="sourceLine" id="cb14-18" data-line-number="18">       <span class="dt">id =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="co">#&gt; # A tibble: 5 x 2</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="co">#&gt;   sample_names    id</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="co">#&gt;   &lt;chr&gt;        &lt;int&gt;</span></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="co">#&gt; 1 zy_1             1</span></a>
<a class="sourceLine" id="cb14-23" data-line-number="23"><span class="co">#&gt; 2 zy_2             2</span></a>
<a class="sourceLine" id="cb14-24" data-line-number="24"><span class="co">#&gt; 3 zy_3             3</span></a>
<a class="sourceLine" id="cb14-25" data-line-number="25"><span class="co">#&gt; 4 zy_4             4</span></a>
<a class="sourceLine" id="cb14-26" data-line-number="26"><span class="co">#&gt; 5 early2cell_1     5</span></a></code></pre></div>
</div>
<div id="exercise-2" class="section level3">
<h3 class="hasAnchor">
<a href="#exercise-2" class="anchor"></a>Exercise</h3>
<p>Tidy the <code>clust_mat</code> matrix into long format and plot the values across time points for each gene. What do you notice about the gene expression. Which are the most similar? similar expression-levels? similar pattern?</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">tidy_mat &lt;-<span class="st"> </span>clust_mat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span><span class="kw">as_tibble</span>(<span class="dt">rownames =</span> <span class="st">"gene"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="st">  </span><span class="kw">gather</span>(timepoint, value, <span class="op">-</span>gene) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">timepoint =</span> <span class="kw">str_remove</span>(timepoint, <span class="st">"timepoint_"</span>),</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">         <span class="dt">timepoint =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(timepoint))</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="kw">ggplot</span>(tidy_mat, <span class="kw">aes</span>(<span class="dt">x =</span> timepoint, <span class="dt">y =</span> value,</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">                     <span class="dt">color =</span> gene)) <span class="op">+</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="generating-heatmaps-using-complexheatmap" class="section level2">
<h2 class="hasAnchor">
<a href="#generating-heatmaps-using-complexheatmap" class="anchor"></a>Generating Heatmaps using ComplexHeatmap</h2>
<p>How do we visualize this dataset to examine relationships between samples? Visualizing the entire scRNA-seq matrix will be computationally expensive and likely completely unintepretable. Ideally we’d like to reduce the dataset to less than a few thousand genes for visualization.</p>
<p>How do we select which genes to plot in a heatmap? 1) For bulk RNA-Seq, generally first identify differentially expressed genes and make a heatmap of these genes.<br>
2) For scRNA-seq you can use the variable genes in the dataset, or genes that are markers of defined clusters.<br>
3) Pick genes of interest related to the hypothesis.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">?Heatmap</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">??Heatmap</a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">gene_variance &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(norm_mat, <span class="dv">1</span>, var) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="dt">decreasing =</span> T)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">vargenes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(gene_variance)[<span class="dv">1</span><span class="op">:</span><span class="dv">30</span>]</a>
<a class="sourceLine" id="cb17-5" data-line-number="5"></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(vargenes)</a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co">#&gt; [1] "Zbed3"        "LOC100502936" "C86187"       "Btg4"         "Alppl2"      </span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="co">#&gt; [6] "Tcl1"</span></a></code></pre></div>
<p>Next we’ll pick a color palette and generate a vector of colors to be used in the heatmap.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">vcols &lt;-<span class="st"> </span>viridis<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="dv">256</span>)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(vcols)</a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="co">#&gt; [1] "#440154FF" "#440256FF" "#450457FF" "#450559FF" "#46075AFF" "#46085CFF"</span></a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">var_mat &lt;-<span class="st"> </span>norm_mat[vargenes, ]</a>
<a class="sourceLine" id="cb19-2" data-line-number="2"></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(var_mat, <span class="dt">col =</span> vcols, <span class="dt">name =</span> <span class="st">"log scale"</span>,</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-18-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Often visualizing gene expression abundance can obscure some patterns, as lower expression values are not as strongly represented. A common data transformation is mean-centering and scaling each gene. This is also known as a z-score.</p>
<p><code>(x - mean(x)) / sd(x)</code></p>
<p>By generating z-scores, the gene expression data now represents standard deviations away from the mean. A built in function in R called <code>scale</code> can generate z-scores. This is also easy to do using an apply function.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">?scale</a></code></pre></div>
<p>The scale function performs scaling per column in a matrix. However, it is common in genomics for matricies to be represented with samples (i.e. cells) as columns and genes as rows. This is done as commonly the number of genes &gt;&gt; than the number of samples, and so it is conviently (and computaionally easier) to represent data in this format.</p>
<p>However, is this a tidy format?</p>
<p>Are the variables stored as rows or columns?</p>
<p>How do we transpose rows to columns and vice-versa?</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">?t</a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">var_mat[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="co">#&gt;                  zy_1     zy_2     zy_3</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="co">#&gt; Zbed3        4.579253 4.329129 4.446267</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co">#&gt; LOC100502936 3.995553 4.024628 4.060731</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="co">#&gt; C86187       3.900258 3.914178 4.026102</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(var_mat) <span class="op">%&gt;%</span><span class="st"> </span>.[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="co">#&gt;         Zbed3 LOC100502936   C86187</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="co">#&gt; zy_1 4.579253     3.995553 3.900258</span></a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="co">#&gt; zy_2 4.329129     4.024628 3.914178</span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="co">#&gt; zy_3 4.446267     4.060731 4.026102</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12"></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"></a>
<a class="sourceLine" id="cb22-14" data-line-number="14">zmat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(var_mat), </a>
<a class="sourceLine" id="cb22-15" data-line-number="15">                <span class="dt">center =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb22-16" data-line-number="16">                <span class="dt">scale =</span> <span class="ot">TRUE</span>)) </a>
<a class="sourceLine" id="cb22-17" data-line-number="17"></a>
<a class="sourceLine" id="cb22-18" data-line-number="18"><span class="co"># confirm that columns are the same after scaling</span></a>
<a class="sourceLine" id="cb22-19" data-line-number="19"><span class="kw"><a href="https://rdrr.io/r/base/all.html">all</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(zmat) <span class="op">==</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(var_mat))</a>
<a class="sourceLine" id="cb22-20" data-line-number="20"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(zmat, <span class="dt">col =</span> vcols,</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">        <span class="dt">name =</span> <span class="st">"z-score"</span>,</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-21-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Multiple heatmaps can be generated and plotted together if they share genes. For example, if we wanted to compare the zscore values to the log expression values.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="co"># save each heatmap as an object</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2">h1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(zmat, <span class="dt">col =</span> vcols,</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">        <span class="dt">name =</span> <span class="st">"z-score"</span>,</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb24-5" data-line-number="5">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb24-6" data-line-number="6"></a>
<a class="sourceLine" id="cb24-7" data-line-number="7">h2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(var_mat, <span class="dt">col =</span> vcols,</a>
<a class="sourceLine" id="cb24-8" data-line-number="8">        <span class="dt">name =</span> <span class="st">"log"</span>,</a>
<a class="sourceLine" id="cb24-9" data-line-number="9">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb24-10" data-line-number="10">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb24-11" data-line-number="11"></a>
<a class="sourceLine" id="cb24-12" data-line-number="12"><span class="co"># use the + operator to combine</span></a>
<a class="sourceLine" id="cb24-13" data-line-number="13">h1 <span class="op">+</span><span class="st"> </span>h2</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-22-1.png" width="1344" style="display: block; margin: auto;"></p>
<p>Lastly, heatmaps can be saved in a variety of formats using built in r functions, <code>pdf</code>, <code>png</code>, <code>svg</code>, and <code>jpeg</code>. <code>ggplots</code> plots can be saved with <code>ggsave</code> or the cowplot wrapper <code>save_plot</code>.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span>(<span class="st">"figure1.pdf"</span>) <span class="co"># name of plot</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2">  h1 <span class="op">+</span><span class="st"> </span>h2 <span class="co"># code that generates the plot</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>() <span class="co"># saves the plot</span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/grDevices/png.html">png</a></span>(<span class="st">"figure1.png"</span>) </a>
<a class="sourceLine" id="cb25-6" data-line-number="6">  h1 <span class="op">+</span><span class="st"> </span>h2 </a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>() </a>
<a class="sourceLine" id="cb25-8" data-line-number="8"></a>
<a class="sourceLine" id="cb25-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/r/grDevices/cairo.html">svg</a></span>(<span class="st">"figure1.svg"</span>) </a>
<a class="sourceLine" id="cb25-10" data-line-number="10">  h1 <span class="op">+</span><span class="st"> </span>h2 </a>
<a class="sourceLine" id="cb25-11" data-line-number="11"><span class="kw"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>() </a>
<a class="sourceLine" id="cb25-12" data-line-number="12"></a>
<a class="sourceLine" id="cb25-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/grDevices/png.html">tiff</a></span>(<span class="st">"figure1.tiff"</span>) </a>
<a class="sourceLine" id="cb25-14" data-line-number="14">  h1 <span class="op">+</span><span class="st"> </span>h2 </a>
<a class="sourceLine" id="cb25-15" data-line-number="15"><span class="kw"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span>() </a></code></pre></div>
<div id="exercises" class="section level3">
<h3 class="hasAnchor">
<a href="#exercises" class="anchor"></a>Exercises</h3>
<p>Create a heatmap using the top 200 variables genes, using either zscores or log normalized data. Consult the help menu to generate a heatmap and save it to a file.</p>
<p>Your heatmap should be made in the following manner:</p>
<ol style="list-style-type: decimal">
<li>cluster by row</li>
<li>hide the rownames</li>
<li>add a title to the legend</li>
<li>add a title to the columns</li>
</ol>
<p>What appears to be happening between the <code>early2cell</code> and <code>mid2cell</code> stages?</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">gene_variance &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(norm_mat, <span class="dv">1</span>, var) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="dt">decreasing =</span> T)</a>
<a class="sourceLine" id="cb26-3" data-line-number="3"></a>
<a class="sourceLine" id="cb26-4" data-line-number="4">vargenes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(gene_variance)[<span class="dv">1</span><span class="op">:</span><span class="dv">200</span>]</a>
<a class="sourceLine" id="cb26-5" data-line-number="5"></a>
<a class="sourceLine" id="cb26-6" data-line-number="6">var_mat &lt;-<span class="st"> </span>norm_mat[vargenes, ]</a>
<a class="sourceLine" id="cb26-7" data-line-number="7"></a>
<a class="sourceLine" id="cb26-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(var_mat, <span class="dt">col =</span> vcols, <span class="dt">name =</span> <span class="st">"log scale"</span>,</a>
<a class="sourceLine" id="cb26-9" data-line-number="9">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb26-10" data-line-number="10">        <span class="dt">show_row_names =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb26-11" data-line-number="11">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb26-12" data-line-number="12">        <span class="dt">column_title =</span> <span class="st">"Samples"</span>, </a>
<a class="sourceLine" id="cb26-13" data-line-number="13">        <span class="dt">row_title =</span> <span class="st">"Genes"</span>)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-24-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="clustering" class="section level2">
<h2 class="hasAnchor">
<a href="#clustering" class="anchor"></a>Clustering</h2>
<p>Reviews:</p>
<ul>
<li><p><a href="http://stke.sciencemag.org/content/9/432/re6">Avoiding common pitfalls when clustering biological data</a></p></li>
<li><p><a href="https://www.nature.com/articles/nbt1205-1499">How does gene expression clustering work?</a></p></li>
<li><p><a href="https://www.nature.com/articles/nmeth.1902">Heatmaps</a></p></li>
</ul>
<p>Consider the following example matrix <code>clust_mat</code> which is part of the package. Data and concept from a <a href="http://www.opiniomics.org/you-probably-dont-understand-heatmaps/">blog post</a> by Mick Watson.</p>
<p>By default many Heatmap packages perform clustering. It’s important to know what these defaults do, and when it is appropriate to use them. Consider the following toy dataset, which is clustered by row.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">clustering_example_plot</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-25-1.png" width="700" style="display: block; margin: auto;"></p>
<p>Here is the heatmap for this data.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(clust_mat, </a>
<a class="sourceLine" id="cb28-2" data-line-number="2">        <span class="dt">col =</span> vcols,</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb28-4" data-line-number="4">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-26-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Does this clustering make sense? Should I1 and I2 be grouped together?</p>
<p>By default hierarchical clustering is performed using euclidean distance as a distance metric. There are many distance metrics, and some are more appropriate for different data. For this data, using euclidean distance will group the highly expressed genes (<code>h1</code> and <code>h2</code>) separate from the lowly expressed (<code>l1</code>, <code>l2</code>). However we can see that the pattern of change over time is more similar between <code>h1</code> and <code>l1</code></p>
<p>We can see the euclidean distances between genes using <code>dist</code>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(clust_mat)</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="co">#&gt;           h1        h2        l1</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="co">#&gt; h2 28.284271                    </span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="co">#&gt; l1 38.470768 40.496913          </span></a>
<a class="sourceLine" id="cb29-5" data-line-number="5"><span class="co">#&gt; l2 40.496913 38.470768  5.656854</span></a></code></pre></div>
<p>The hierarchical clustering is done by default using <code>dist</code> as input.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">hc &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(clust_mat))</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(hc)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-28-1.png" width="672" style="display: block; margin: auto;"></p>
<p>We can change the distance metric used for the Heatmap by changing the <code>clustering_distance_rows</code> argument. A correlation measure, is not sensitive to abundance, and can recover the shared patterns in the data.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(clust_mat))</a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="co">#&gt;    h1 h2 l1 l2</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="co">#&gt; h1  1 -1  1 -1</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="co">#&gt; h2 -1  1 -1  1</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="co">#&gt; l1  1 -1  1 -1</span></a>
<a class="sourceLine" id="cb31-6" data-line-number="6"><span class="co">#&gt; l2 -1  1 -1  1</span></a></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"></a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(clust_mat, <span class="dt">col =</span> vcols,</a>
<a class="sourceLine" id="cb32-3" data-line-number="3">        <span class="dt">clustering_distance_rows =</span> <span class="st">"pearson"</span>,</a>
<a class="sourceLine" id="cb32-4" data-line-number="4">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb32-5" data-line-number="5">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-30-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Alternatively we could also generate zscores and use these to plot.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">zmat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>(clust_mat)))</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"></a>
<a class="sourceLine" id="cb33-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(zmat, <span class="dt">col =</span> vcols,</a>
<a class="sourceLine" id="cb33-4" data-line-number="4">        <span class="dt">clustering_distance_rows =</span> <span class="st">"euclidean"</span>,</a>
<a class="sourceLine" id="cb33-5" data-line-number="5">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb33-6" data-line-number="6">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-31-1.png" width="672" style="display: block; margin: auto;"></p>
<div id="extracting-out-clusters" class="section level3">
<h3 class="hasAnchor">
<a href="#extracting-out-clusters" class="anchor"></a>Extracting out clusters</h3>
<p>First let’s return to our heatmap of variable genes from the single cell data.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">h1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(var_mat, <span class="dt">col =</span> vcols, <span class="dt">name =</span> <span class="st">"log scale"</span>,</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb34-3" data-line-number="3">        <span class="dt">show_row_names =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb34-4" data-line-number="4">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb34-5" data-line-number="5">        <span class="dt">column_title =</span> <span class="st">"Correlation"</span>, </a>
<a class="sourceLine" id="cb34-6" data-line-number="6">        <span class="dt">row_title =</span> <span class="st">"Genes"</span>)</a>
<a class="sourceLine" id="cb34-7" data-line-number="7">h1</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-32-1.png" width="672" style="display: block; margin: auto;"></p>
<p>How do we select out individual clusters? How do we define clusters?</p>
<p>First let’s generate the dendogram:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">hc &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(var_mat))</a>
<a class="sourceLine" id="cb35-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(hc)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-33-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Next we can use <code><a href="https://rdrr.io/r/stats/cutree.html">cutree()</a></code> to cut the tree into groups</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">?cutree</a></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="co"># split into 5 groups</span></a>
<a class="sourceLine" id="cb37-2" data-line-number="2">kclusters &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span>(hc, <span class="dt">k =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb37-3" data-line-number="3"></a>
<a class="sourceLine" id="cb37-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(hc, <span class="dt">labels =</span> kclusters)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-35-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"></a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="co"># split based on height of tree</span></a>
<a class="sourceLine" id="cb38-3" data-line-number="3">hclusters &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span>(hc, <span class="dt">h =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb38-4" data-line-number="4"></a>
<a class="sourceLine" id="cb38-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(hc, <span class="dt">labels =</span> hclusters)</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-35-2.png" width="672" style="display: block; margin: auto;"></p>
<p>Now that we have assigned clusters we can replot our heatmaps split out by each cluster.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">h1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span>(var_mat, <span class="dt">col =</span> vcols, <span class="dt">name =</span> <span class="st">"log scale"</span>,</a>
<a class="sourceLine" id="cb39-2" data-line-number="2">        <span class="dt">cluster_rows =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb39-3" data-line-number="3">        <span class="dt">show_row_names =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb39-4" data-line-number="4">        <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb39-5" data-line-number="5">        <span class="dt">split =</span> kclusters, </a>
<a class="sourceLine" id="cb39-6" data-line-number="6">        <span class="dt">row_title =</span> <span class="st">"Genes"</span>)</a>
<a class="sourceLine" id="cb39-7" data-line-number="7">h1</a></code></pre></div>
<p><img src="class-7_files/figure-html/unnamed-chunk-36-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div id="k-means" class="section level3">
<h3 class="hasAnchor">
<a href="#k-means" class="anchor"></a>K-means</h3>
<p>K-means clustering is another simple, yet powerful clustering techinuqe. It also scales to much larger datasets than hierarchical clustering.</p>
<p>description: - <a href="http://onmyphd.com/?p=k-means.clustering">interactive description</a></p>
<ul>
<li><p><a href="https://en.wikipedia.org/wiki/K-means_clustering">detailed description</a></p></li>
<li><p><a href="https://stackoverflow.com/questions/15376075/cluster-analysis-in-r-determine-the-optimal-number-of-clusters">determining number of clusters</a></p></li>
</ul>
<p>Kmeans is easily implemented using <code><a href="https://rdrr.io/r/stats/kmeans.html">kmeans()</a></code></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">clusters &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span>(var_mat, <span class="dt">centers =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(clusters)</a>
<a class="sourceLine" id="cb40-3" data-line-number="3"><span class="co">#&gt; [1] "cluster"      "centers"      "totss"        "withinss"     "tot.withinss"</span></a>
<a class="sourceLine" id="cb40-4" data-line-number="4"><span class="co">#&gt; [6] "betweenss"    "size"         "iter"         "ifault"</span></a></code></pre></div>
<p>Cluster assignments can be extracted using <code>$cluster</code></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">clusters<span class="op">$</span>cluster <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()</a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="co">#&gt;        Zbed3 LOC100502936       C86187         Btg4       Alppl2         Tcl1 </span></a>
<a class="sourceLine" id="cb41-3" data-line-number="3"><span class="co">#&gt;            3            1            3            3            5            3</span></a></code></pre></div>
<p>To recover a reproducible kmeans classification set a seed for the random number generator</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb42-2" data-line-number="2">clusters &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span>(var_mat, <span class="dt">centers =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb42-3" data-line-number="3">clusters<span class="op">$</span>cluster <span class="op">%&gt;%</span><span class="st"> </span>head</a>
<a class="sourceLine" id="cb42-4" data-line-number="4"><span class="co">#&gt;        Zbed3 LOC100502936       C86187         Btg4       Alppl2         Tcl1 </span></a>
<a class="sourceLine" id="cb42-5" data-line-number="5"><span class="co">#&gt;            5            5            5            5            2            5</span></a></code></pre></div>
</div>
<div id="exercise-3" class="section level3">
<h3 class="hasAnchor">
<a href="#exercise-3" class="anchor"></a>Exercise:</h3>
<ol style="list-style-type: decimal">
<li><p>Make a Heatmap split by each kmeans cluster</p></li>
<li><p>use your tidying skills to plot the average expression per cluster.</p></li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#matrix-operations">Matrix operations</a></li>
      <li><a href="#generating-heatmaps-using-complexheatmap">Generating Heatmaps using ComplexHeatmap</a></li>
      <li><a href="#clustering">Clustering</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://hesselberthlab.org">Jay Hesselberth</a>, Austin Gillen, Kent Riemondy, Rui Fu, Ryan Sheridan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
